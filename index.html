<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<title>SAQIB MARKET</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<style>
body{
  margin:0;
  font-family:tahoma;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  color:#fff;
  text-align:center;
}
.card{
  background:#111;
  max-width:400px;
  margin:30px auto;
  padding:20px;
  border-radius:20px;
  box-shadow:0 0 20px #000;
}
input,button{
  width:90%;
  padding:12px;
  margin:6px;
  border:none;
  border-radius:10px;
}
button{
  background:linear-gradient(45deg,#ff512f,#dd2476);
  color:white;
  font-weight:bold;
}
img{
  width:90px;
  height:90px;
  border-radius:50%;
  object-fit:cover;
  border:3px solid #ff2f92;
}
#chatBox{display:none}
#messages{
  background:#000;
  border-radius:10px;
  padding:10px;
  margin-top:10px;
  max-height:200px;
  overflow:auto;
  text-align:right;
}
</style>
</head>

<body>

<h2>ğŸ”¥ SAQIB MARKET ğŸ”¥</h2>

<!-- LOGIN -->
<div class="card" id="auth">
  <input id="email" placeholder="Ø§ÛŒÙ…ÛŒÙ„">
  <input id="password" type="password" placeholder="Ù¾Ø³ÙˆØ±Ø¯">
  <button onclick="register()">Ø«Ø¨Øª Ù†Ø§Ù…</button>
  <button onclick="login()">ÙˆØ±ÙˆØ¯</button>
</div>

<!-- PROFILE -->
<div class="card" id="profile" style="display:none">
  <img id="avatar">
  <input id="name" placeholder="Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ">
  <input type="file" id="photo">
  <button onclick="saveProfile()">Ø°Ø®ÛŒØ±Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„</button>
</div>

<!-- CHAT -->
<div class="card" id="chat" style="display:none">
  <h4 id="me"></h4>
  <input id="peer" placeholder="Ø§ÛŒÙ…ÛŒÙ„ Ø·Ø±Ù Ù…Ù‚Ø§Ø¨Ù„">
  <button onclick="startChat()">Ø´Ø±ÙˆØ¹ Ú†Øª</button>

  <div id="chatBox">
    <input id="msg" placeholder="Ù¾ÛŒØ§Ù…">
    <button onclick="send()">Ø§Ø±Ø³Ø§Ù„</button>
    <button onclick="logout()">Ø®Ø±ÙˆØ¬</button>
    <div id="messages"></div>
  </div>
</div>

<script>
// Firebase config
firebase.initializeApp({
  apiKey:"AIzaSyAHJ_2UP6n4RyGcuWmfa1hJA_n8B1C5C2Q",
  authDomain:"saqibmarket.firebaseapp.com",
  databaseURL:"https://saqibmarket-default-rtdb.firebaseio.com",
  projectId:"saqibmarket",
  storageBucket:"saqibmarket.appspot.com"
});

const auth=firebase.auth();
const db=firebase.database();
const st=firebase.storage();
let chatId=null;

// Auth
function register(){
  auth.createUserWithEmailAndPassword(email.value,password.value)
  .then(()=>alert("Ø«Ø¨Øª Ù†Ø§Ù… Ù…ÙˆÙÙ‚ âœ…"))
  .catch(e=>alert(e.message));
}
function login(){
  auth.signInWithEmailAndPassword(email.value,password.value)
  .catch(e=>alert(e.message));
}

auth.onAuthStateChanged(u=>{
  if(!u)return;
  authDiv.style.display="none";
  profile.style.display="block";
  chat.style.display="block";
  me.innerText=u.email;

  db.ref("users/"+u.uid).once("value",s=>{
    if(s.exists()){
      name.value=s.val().name;
      avatar.src=s.val().photo;
    }
  });
});

// Save profile
function saveProfile(){
  const u=auth.currentUser;
  const file=photo.files[0];
  if(!file)return alert("Ø¹Ú©Ø³ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†");

  st.ref("avatars/"+u.uid).put(file).then(r=>{
    r.ref.getDownloadURL().then(url=>{
      db.ref("users/"+u.uid).set({
        name:name.value,
        photo:url
      });
      avatar.src=url;
      alert("Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ âœ…");
    });
  });
}

// Chat
function startChat(){
  const u=auth.currentUser;
  chatId=btoa([u.email,peer.value].sort().join("_"));
  chatBox.style.display="block";
  messages.innerHTML="";
  db.ref("chats/"+chatId).off();
  db.ref("chats/"+chatId).on("child_added",s=>{
    const p=document.createElement("p");
    p.innerText=s.val();
    messages.appendChild(p);
  });
}
function send(){
  db.ref("chats/"+chatId).push(name.value+": "+msg.value);
  msg.value="";
}
function logout(){
  auth.signOut();location.reload();
}
</script>

</body>
</html>
