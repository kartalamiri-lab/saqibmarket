<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<title>SAQIB CHAT</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<style>
body{
  margin:0;
  background:#0e0e11;
  color:#fff;
  font-family:tahoma
}
.hidden{display:none}
header{
  background:#121218;
  padding:14px;
  text-align:center;
  font-weight:bold;
  font-size:18px
}
input,button{
  padding:12px;
  border:none;
  border-radius:12px;
  margin:6px;
  width:92%
}
button{
  background:#4da3ff;
  color:#fff;
  font-weight:bold
}
section{padding:14px}

.user{
  display:flex;
  align-items:center;
  padding:10px;
  border-bottom:1px solid #222;
  cursor:pointer
}
.user img{
  width:45px;
  height:45px;
  border-radius:50%;
  margin-left:10px
}

#messages{
  height:55vh;
  overflow-y:auto;
  padding:6px
}
.msg{
  max-width:70%;
  padding:10px;
  border-radius:14px;
  margin:6px 0;
  font-size:14px
}
.me{
  background:#4da3ff;
  margin-left:auto
}
.other{
  background:#2a2a33
}

#sendBox{
  display:flex;
  gap:6px
}
#sendBox input{flex:1}
</style>
</head>

<body>

<header>SAQIB CHAT</header>

<!-- LOGIN -->
<section id="login">
  <input id="name" placeholder="نام">
  <input id="email" placeholder="ایمیل">
  <input id="pass" type="password" placeholder="پسورد">
  <button onclick="login()">ورود / ثبت‌نام</button>
</section>

<!-- SETTINGS -->
<section id="settings" class="hidden">
  <h3>تنظیمات پروفایل</h3>
  <input type="file" id="photoFile" accept="image/*">
  <button onclick="uploadPhoto()">ذخیره عکس</button>
</section>

<!-- USERS -->
<section id="users" class="hidden">
  <h3>کاربران</h3>
  <div id="userList"></div>
</section>

<!-- CHAT -->
<section id="chat" class="hidden">
  <h3 id="chatTitle"></h3>
  <div id="messages"></div>
  <div id="sendBox">
    <input id="text" placeholder="پیام...">
    <button onclick="send()">➤</button>
  </div>
</section>

<script>
// Firebase Init
firebase.initializeApp({
  apiKey: "AIzaSyAHJ_2UP6n4RyGcuWmfa1hJA_n8B1C5C2Q",
  authDomain: "saqibmarket.firebaseapp.com",
  databaseURL: "https://saqibmarket-default-rtdb.firebaseio.com",
  projectId: "saqibmarket",
  storageBucket: "saqibmarket.appspot.com"
});

const auth = firebase.auth();
const db = firebase.database();
const storage = firebase.storage();

let me=null;
let chatId=null;

// LOGIN
function login(){
  if(!email.value || !pass.value){
    alert("ایمیل و پسورد را وارد کن");
    return;
  }
  auth.signInWithEmailAndPassword(email.value,pass.value)
  .catch(()=>auth.createUserWithEmailAndPassword(email.value,pass.value));
}

// AUTH STATE
auth.onAuthStateChanged(u=>{
  if(!u) return;
  me=u;

  db.ref("users/"+u.uid).update({
    name: name.value || "User",
    photo: "https://i.imgur.com/6VBx3io.png"
  });

  login.classList.add("hidden");
  settings.classList.remove("hidden");
  users.classList.remove("hidden");

  loadUsers();
});

// UPLOAD PHOTO
function uploadPhoto(){
  const file = photoFile.files[0];
  if(!file) return alert("عکس انتخاب کن");

  const ref = storage.ref("profiles/"+me.uid+".jpg");
  ref.put(file).then(()=>{
    ref.getDownloadURL().then(url=>{
      db.ref("users/"+me.uid+"/photo").set(url);
      alert("عکس ذخیره شد ✅");
    });
  });
}

// LOAD USERS
function loadUsers(){
  userList.innerHTML="";
  db.ref("users").on("child_added",s=>{
    if(s.key===me.uid) return;
    const d=s.val();
    const div=document.createElement("div");
    div.className="user";
    div.innerHTML=`<img src="${d.photo}"><span>${d.name}</span>`;
    div.onclick=()=>openChat(s.key,d.name);
    userList.appendChild(div);
  });
}

// OPEN CHAT
function openChat(uid,name){
  chatId=[me.uid,uid].sort().join("_");
  chat.classList.remove("hidden");
  chatTitle.innerText=name;
  messages.innerHTML="";

  db.ref("chats/"+chatId).off();
  db.ref("chats/"+chatId).on("child_added",s=>{
    const m=s.val();
    const div=document.createElement("div");
    div.className="msg "+(m.uid===me.uid?"me":"other");
    div.innerText=m.text;
    messages.appendChild(div);
    messages.scrollTop=messages.scrollHeight;
  });
}

// SEND MESSAGE
function send(){
  if(!text.value || !chatId) return;
  db.ref("chats/"+chatId).push({
    uid:me.uid,
    text:text.value,
    time:Date.now()
  });
  text.value="";
}
</script>

</body>
</html>
