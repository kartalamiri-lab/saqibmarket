
<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<title>SAQIB CHAT</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{margin:0;background:#0e0e11;color:#fff;font-family:tahoma}
.hidden{display:none}
header{background:#121218;padding:14px;text-align:center;font-weight:bold}
input,button{padding:10px;border:none;border-radius:10px;margin:6px;width:90%}
button{background:#4da3ff;color:#fff}
#login,#users,#chat{padding:14px}
.user{display:flex;align-items:center;padding:10px;border-bottom:1px solid #222;cursor:pointer}
.user img{width:45px;height:45px;border-radius:50%;margin-left:10px}
#messages{height:60vh;overflow-y:auto}
.msg{max-width:70%;padding:10px;border-radius:14px;margin:6px 0}
.me{background:#4da3ff;margin-left:auto}
.other{background:#2a2a33}
#sendBox{display:flex}
#sendBox input{flex:1}
</style>
</head>

<body>

<header>SAQIB CHAT</header>

<!-- LOGIN -->
<div id="login">
  <input id="name" placeholder="نام">
  <input id="photo" placeholder="لینک عکس پروفایل">
  <input id="email" placeholder="ایمیل">
  <input id="pass" type="password" placeholder="پسورد">
  <button onclick="login()">ورود / ثبت‌نام</button>
</div>

<!-- USER LIST -->
<div id="users" class="hidden">
  <h3>کاربران</h3>
  <div id="userList"></div>
</div>

<!-- CHAT -->
<div id="chat" class="hidden">
  <h3 id="chatTitle"></h3>
  <div id="messages"></div>
  <div id="sendBox">
    <input id="text" placeholder="پیام...">
    <button onclick="send()">➤</button>
  </div>
</div>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyAHJ_2UP6n4RyGcuWmfa1hJA_n8B1C5C2Q",
  authDomain: "saqibmarket.firebaseapp.com",
  databaseURL: "https://saqibmarket-default-rtdb.firebaseio.com",
  projectId: "saqibmarket"
});

const auth=firebase.auth();
const db=firebase.database();

let myUser=null;
let chatId=null;
let peerId=null;

/* LOGIN */
function login(){
  auth.signInWithEmailAndPassword(email.value,pass.value)
  .catch(()=>{
    auth.createUserWithEmailAndPassword(email.value,pass.value);
  });
}

auth.onAuthStateChanged(u=>{
  if(!u) return;
  myUser=u;

  db.ref("users/"+u.uid).set({
    name:name.value||"User",
    photo:photo.value||"https://i.imgur.com/6VBx3io.png"
  });

  login.classList.add("hidden");
  users.classList.remove("hidden");

  loadUsers();
});

/* LOAD USERS */
function loadUsers(){
  userList.innerHTML="";
  db.ref("users").on("child_added",snap=>{
    if(snap.key===myUser.uid) return;
    const d=snap.val();
    const div=document.createElement("div");
    div.className="user";
    div.innerHTML=`<img src="${d.photo}"><span>${d.name}</span>`;
    div.onclick=()=>openChat(snap.key,d.name);
    userList.appendChild(div);
  });
}

/* OPEN CHAT */
function openChat(uid,name){
  peerId=uid;
  chatId=[myUser.uid,peerId].sort().join("_");
  users.classList.add("hidden");
  chat.classList.remove("hidden");
  chatTitle.innerText=name;
  messages.innerHTML="";

  db.ref("chats/"+chatId).off();
  db.ref("chats/"+chatId).on("child_added",s=>{
    const m=s.val();
    const div=document.createElement("div");
    div.className="msg "+(m.uid===myUser.uid?"me":"other");
    div.innerText=m.text;
    messages.appendChild(div);
    messages.scrollTop=messages.scrollHeight;
  });
}

/* SEND */
function send(){
  if(!text.value) return;
  db.ref("chats/"+chatId).push({
    uid:myUser.uid,
    text:text.value,
    time:Date.now()
  });
  text.value="";
}
</script>

</body>
</html>
