
<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<title>Private Chat</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{
  margin:0;
  background:#0e0e11;
  color:#fff;
  font-family:Arial;
}
header{
  padding:15px;
  background:#121218;
  display:flex;
  align-items:center;
}
header img{
  width:42px;
  height:42px;
  border-radius:50%;
  margin-left:10px;
}
#messages{
  padding:15px;
  height:calc(100vh - 130px);
  overflow-y:auto;
}
.msg{
  max-width:70%;
  margin:8px 0;
  padding:10px 14px;
  border-radius:16px;
  line-height:1.4;
}
.me{
  background:linear-gradient(135deg,#4da3ff,#357bff);
  margin-left:auto;
}
.other{
  background:#2a2a33;
}
#sendBox{
  position:fixed;
  bottom:0;
  width:100%;
  display:flex;
  background:#121218;
  padding:10px;
}
#sendBox input{
  flex:1;
  padding:12px;
  border:none;
  border-radius:20px;
  outline:none;
}
#sendBox button{
  margin-right:10px;
  padding:10px 16px;
  border:none;
  border-radius:50%;
  background:#4da3ff;
  color:#fff;
}
</style>
</head>
<body>

<header>
  <img id="peerPhoto">
  <span id="peerName">Chat</span>
</header>

<div id="messages"></div>

<div id="sendBox">
  <input id="msg" placeholder="Ù¾ÛŒØ§Ù… Ø¨Ù†ÙˆÛŒØ³...">
  <button onclick="send()">â¤</button>
</div>

<script>
/* ğŸ”¥ Firebase */
firebase.initializeApp({
  apiKey: "AIzaSyAHJ_2UP6n4RyGcuWmfa1hJA_n8B1C5C2Q",
  authDomain: "saqibmarket.firebaseapp.com",
  databaseURL: "https://saqibmarket-default-rtdb.firebaseio.com",
  projectId: "saqibmarket"
});

const auth = firebase.auth();
const db   = firebase.database();

/* Ú¯Ø±ÙØªÙ† UID Ø·Ø±Ù Ù…Ù‚Ø§Ø¨Ù„ */
const params = new URLSearchParams(location.search);
const peerId = params.get("uid");

if(!peerId){
  alert("Ú†Øª Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª");
  location.href="chats.html";
}

let chatId = null;

/* ğŸ” Ø¨Ø¹Ø¯ Ø§Ø² Ù„Ø§Ú¯ÛŒÙ† */
auth.onAuthStateChanged(user=>{
  if(!user){
    location.href="index.html";
    return;
  }

  /* Ø°Ø®ÛŒØ±Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø®ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø± (Ø§Ú¯Ø± Ù†Ø¨ÙˆØ¯) */
  db.ref("users/"+user.uid).update({
    email: user.email
  });

  chatId = [user.uid, peerId].sort().join("_");

  /* Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø·Ø±Ù Ù…Ù‚Ø§Ø¨Ù„ */
  db.ref("users/"+peerId).once("value",s=>{
    const d=s.val()||{};
    peerName.innerText = d.name || "User";
    peerPhoto.src = d.photo || "https://i.imgur.com/6VBx3io.png";
  });

  /* Ø¯Ø±ÛŒØ§ÙØª Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ */
  db.ref("chats/"+chatId+"/messages").limitToLast(100)
    .on("child_added",snap=>{
      const m = snap.val();
      const div = document.createElement("div");
      div.className = "msg " + (m.uid===user.uid?"me":"other");
      div.innerText = m.text;
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
  });
});

/* âœ‰ï¸ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… */
function send(){
  if(!msg.value.trim()) return;

  const u = auth.currentUser;
  const text = msg.value;

  const messageData = {
    uid: u.uid,
    text: text,
    time: Date.now()
  };

  /* Ù¾ÛŒØ§Ù… */
  db.ref("chats/"+chatId+"/messages").push(messageData);

  /* Ø¢Ø®Ø±ÛŒÙ† Ù¾ÛŒØ§Ù… Ø¨Ø±Ø§ÛŒ Ù„ÛŒØ³Øª Ú†Øªâ€ŒÙ‡Ø§ */
  db.ref("chats/"+chatId+"/last").set({
    text: text,
    time: Date.now(),
    from: u.uid
  });

  msg.value="";
}
</script>

</body>
</html>
