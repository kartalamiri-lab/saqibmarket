<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<title>SAQIB MARKET</title>

<!-- Firebase Compat -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<style>
body{
  margin:0;
  font-family:tahoma;
  background:radial-gradient(circle at top,#1e293b,#020617);
  color:#fff;
  text-align:center;
}
.card{
  max-width:380px;
  margin:25px auto;
  background:#020617;
  padding:20px;
  border-radius:18px;
  box-shadow:0 20px 40px rgba(0,0,0,.7);
}
h2{margin-bottom:10px}
input,button{
  width:92%;
  padding:12px;
  margin:6px 0;
  border:none;
  border-radius:10px;
  font-size:14px;
}
input{background:#0f172a;color:#fff}
button{
  background:linear-gradient(45deg,#ff512f,#dd2476);
  color:#fff;
  font-weight:bold;
}
img{
  width:90px;height:90px;
  border-radius:50%;
  object-fit:cover;
  border:3px solid #ff4b2b;
}
#profile,#chat,#chatBox{display:none}
#messages{
  background:#020617;
  border-radius:10px;
  padding:10px;
  max-height:220px;
  overflow:auto;
  margin-top:10px;
  text-align:right;
}
.msg{margin:4px 0}
.me{color:#38bdf8}
.other{color:#f472b6}
</style>
</head>

<body>

<h2>ğŸ¬ SAQIB MARKET</h2>

<!-- LOGIN -->
<div class="card" id="loginCard">
  <input id="email" placeholder="Ø§ÛŒÙ…ÛŒÙ„">
  <input id="password" type="password" placeholder="Ù¾Ø³ÙˆØ±Ø¯">
  <button onclick="register()">Ø«Ø¨Øª Ù†Ø§Ù…</button>
  <button onclick="login()">ÙˆØ±ÙˆØ¯</button>
</div>

<!-- PROFILE -->
<div class="card" id="profile">
  <img id="avatar">
  <input id="name" placeholder="Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ">
  <input type="file" id="photo">
  <button onclick="saveProfile()">Ø°Ø®ÛŒØ±Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„</button>
</div>

<!-- CHAT -->
<div class="card" id="chat">
  <div id="me"></div>
  <input id="peerEmail" placeholder="Ø§ÛŒÙ…ÛŒÙ„ Ø·Ø±Ù Ù…Ù‚Ø§Ø¨Ù„">
  <button onclick="startChat()">Ø´Ø±ÙˆØ¹ Ú†Øª Ø®ØµÙˆØµÛŒ</button>

  <div id="chatBox">
    <input id="msg" placeholder="Ù¾ÛŒØ§Ù…">
    <button onclick="send()">Ø§Ø±Ø³Ø§Ù„</button>
    <button onclick="logout()">Ø®Ø±ÙˆØ¬</button>
    <div id="messages"></div>
  </div>
</div>

<script>
/* Firebase config */
firebase.initializeApp({
  apiKey: "AIzaSyAHJ_2UP6n4RyGcuWmfa1hJA_n8B1C5C2Q",
  authDomain: "saqibmarket.firebaseapp.com",
  databaseURL: "https://saqibmarket-default-rtdb.firebaseio.com",
  projectId: "saqibmarket",
  storageBucket: "saqibmarket.appspot.com"
});

const firebaseAuth = firebase.auth();
const db = firebase.database();
const storage = firebase.storage();

let chatId = null;

/* Ø«Ø¨Øª Ù†Ø§Ù… */
function register(){
  firebaseAuth.createUserWithEmailAndPassword(email.value,password.value)
  .then(()=>alert("Ø«Ø¨Øª Ù†Ø§Ù… Ù…ÙˆÙÙ‚ âœ…"))
  .catch(e=>alert(e.message));
}

/* ÙˆØ±ÙˆØ¯ */
function login(){
  firebaseAuth.signInWithEmailAndPassword(email.value,password.value)
  .catch(e=>alert(e.message));
}

/* ÙˆØ¶Ø¹ÛŒØª Ù„Ø§Ú¯ÛŒÙ† */
firebaseAuth.onAuthStateChanged(user=>{
  if(!user) return;

  loginCard.style.display="none";
  profile.style.display="block";
  chat.style.display="block";
  me.innerText = "ğŸ‘¤ " + user.email;

  db.ref("users/"+user.uid).once("value",s=>{
    if(s.exists()){
      name.value = s.val().name || "";
      avatar.src = s.val().photo || "";
    }
  });
});

/* Ø°Ø®ÛŒØ±Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ */
function saveProfile(){
  const user = firebaseAuth.currentUser;
  const file = photo.files[0];
  if(!file) return alert("Ø¹Ú©Ø³ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†");

  storage.ref("avatars/"+user.uid).put(file).then(r=>{
    r.ref.getDownloadURL().then(url=>{
      db.ref("users/"+user.uid).set({
        name: name.value,
        photo: url
      });
      avatar.src = url;
      alert("Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ âœ…");
    });
  });
}

/* Ø´Ø±ÙˆØ¹ Ú†Øª Ø®ØµÙˆØµÛŒ */
function startChat(){
  const user = firebaseAuth.currentUser;
  if(!peerEmail.value) return alert("Ø§ÛŒÙ…ÛŒÙ„ Ø·Ø±Ù Ù…Ù‚Ø§Ø¨Ù„ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†");

  chatId = btoa([user.email, peerEmail.value].sort().join("_"));
  chatBox.style.display="block";
  messages.innerHTML="";

  db.ref("chats/"+chatId).off();
  db.ref("chats/"+chatId).on("child_added",s=>{
    const div = document.createElement("div");
    div.className = "msg " + (s.val().from===user.email ? "me":"other");
    div.innerText = s.val().from + ": " + s.val().text;
    messages.appendChild(div);
  });
}

/* Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… */
function send(){
  if(!msg.value || !chatId) return;
  db.ref("chats/"+chatId).push({
    from: firebaseAuth.currentUser.email,
    text: msg.value
  });
  msg.value="";
}

/* Ø®Ø±ÙˆØ¬ */
function logout(){
  firebaseAuth.signOut();
  location.reload();
}
</script>

</body>
</html>
