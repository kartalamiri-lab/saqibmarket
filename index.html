<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<title>Cinematic Chat</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{
  margin:0;
  background:#0e0e11;
  color:#fff;
  font-family:tahoma;
}
.hidden{display:none}
header{
  padding:15px;
  background:#121218;
  text-align:center;
  font-size:18px;
}
#users .user{
  padding:12px;
  border-bottom:1px solid #222;
  cursor:pointer;
}
#users .user:hover{background:#1a1a22}
#messages{
  height:calc(100vh - 140px);
  overflow-y:auto;
  padding:10px;
}
.msg{
  max-width:70%;
  margin:6px 0;
  padding:10px;
  border-radius:14px;
}
.me{background:#4da3ff;margin-left:auto}
.other{background:#2a2a33}
#sendBox{
  display:flex;
  padding:10px;
  background:#121218;
}
#sendBox input{
  flex:1;
  padding:10px;
  border:none;
  border-radius:20px;
}
#sendBox button{
  margin-right:8px;
  border:none;
  border-radius:50%;
  width:40px;
  background:#4da3ff;
  color:#fff;
}
</style>
</head>
<body>

<header id="title">Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„...</header>

<!-- Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† -->
<div id="users" class="hidden"></div>

<!-- ØµÙØ­Ù‡ Ú†Øª -->
<div id="chat" class="hidden">
  <div id="messages"></div>
  <div id="sendBox">
    <input id="msg" placeholder="Ù¾ÛŒØ§Ù…...">
    <button onclick="send()">â¤</button>
  </div>
</div>

<script>
// ğŸ”¥ Firebase config
firebase.initializeApp({
  apiKey: "API_KEY",
  authDomain: "PROJECT.firebaseapp.com",
  databaseURL: "https://PROJECT-default-rtdb.firebaseio.com",
  projectId: "PROJECT"
});

const auth = firebase.auth();
const db   = firebase.database();

let currentUser = null;
let currentChat = null;

// âœ… Ù„Ø§Ú¯ÛŒÙ† Ø®ÙˆØ¯Ú©Ø§Ø±
auth.signInAnonymously();

auth.onAuthStateChanged(u=>{
  if(!u) return;
  currentUser = u;
  title.innerText = "Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø± Ø¨Ø±Ø§ÛŒ Ú†Øª";

  // Ø°Ø®ÛŒØ±Ù‡ Ú©Ø§Ø±Ø¨Ø±
  db.ref("users/"+u.uid).set({
    name:"User-"+u.uid.slice(0,5)
  });

  loadUsers();
});

// ğŸ‘¥ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
function loadUsers(){
  users.classList.remove("hidden");
  db.ref("users").on("value",snap=>{
    users.innerHTML="";
    snap.forEach(s=>{
      if(s.key===currentUser.uid) return;
      const d=s.val();
      const div=document.createElement("div");
      div.className="user";
      div.innerText=d.name;
      div.onclick=()=>openChat(s.key,d.name);
      users.appendChild(div);
    });
  });
}

// ğŸ’¬ Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ú†Øª
function openChat(uid,name){
  users.classList.add("hidden");
  chat.classList.remove("hidden");
  title.innerText=name;
  messages.innerHTML="";

  currentChat=[currentUser.uid,uid].sort().join("_");

  db.ref("chats/"+currentChat).off();
  db.ref("chats/"+currentChat).on("child_added",s=>{
    const m=s.val();
    const div=document.createElement("div");
    div.className="msg "+(m.uid===currentUser.uid?"me":"other");
    div.innerText=m.text;
    messages.appendChild(div);
    messages.scrollTop=messages.scrollHeight;
  });
}

// âœ‰ï¸ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…
function send(){
  if(!msg.value) return;
  db.ref("chats/"+currentChat).push({
    uid:currentUser.uid,
    text:msg.value,
    time:Date.now()
  });
  msg.value="";
}
</script>

</body>
</html>
