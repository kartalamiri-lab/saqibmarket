<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<title>SAQIB CHAT</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<style>
body{margin:0;background:#0e0e11;color:#fff;font-family:tahoma}
.hidden{display:none}
header{background:#121218;padding:14px;text-align:center;font-weight:bold}
input,button{padding:10px;border:none;border-radius:10px;margin:6px;width:90%}
button{background:#4da3ff;color:#fff}
.user{display:flex;align-items:center;padding:10px;border-bottom:1px solid #222;cursor:pointer}
.user img{width:45px;height:45px;border-radius:50%;margin-left:10px}
#messages{height:55vh;overflow-y:auto}
.msg{max-width:70%;padding:10px;border-radius:14px;margin:6px 0}
.me{background:#4da3ff;margin-left:auto}
.other{background:#2a2a33}
#sendBox{display:flex}
#sendBox input{flex:1}
</style>
</head>

<body>

<header>SAQIB CHAT</header>

<!-- LOGIN -->
<div id="login">
  <input id="name" placeholder="نام">
  <input id="email" placeholder="ایمیل">
  <input id="pass" type="password" placeholder="پسورد">
  <button onclick="login()">ورود / ثبت‌نام</button>
</div>

<!-- SETTINGS -->
<div id="settings" class="hidden">
  <h3>تنظیمات پروفایل</h3>
  <input type="file" id="photoFile" accept="image/*">
  <button onclick="uploadPhoto()">ذخیره عکس</button>
</div>

<!-- USERS -->
<div id="users" class="hidden">
  <h3>کاربران</h3>
  <div id="userList"></div>
</div>

<!-- CHAT -->
<div id="chat" class="hidden">
  <h3 id="chatTitle"></h3>
  <div id="messages"></div>
  <div id="sendBox">
    <input id="text" placeholder="پیام...">
    <button onclick="send()">➤</button>
  </div>
</div>

<script>
/* Firebase Init */
firebase.initializeApp({
  apiKey: "AIzaSyAHJ_2UP6n4RyGcuWmfa1hJA_n8B1C5C2Q",
  authDomain: "saqibmarket.firebaseapp.com",
  databaseURL: "https://saqibmarket-default-rtdb.firebaseio.com",
  projectId: "saqibmarket",
  storageBucket: "saqibmarket.appspot.com"
});

const auth = firebase.auth();
const db = firebase.database();
const storage = firebase.storage();

let me=null, chatId=null;

/* LOGIN */
function login(){
  auth.signInWithEmailAndPassword(email.value,pass.value)
  .catch(()=>auth.createUserWithEmailAndPassword(email.value,pass.value));
}

/* AUTH STATE */
auth.onAuthStateChanged(u=>{
  if(!u) return;
  me=u;

   db.ref("users/"+u.uid).once("value",snap=>{
  if(!snap.exists()){
    db.ref("users/"+u.uid).set({
      name: name.value || "User",
      photo: "https://i.imgur.com/6VBx3io.png"
    });
  }
});  

  l..classLis..add("hidden";
   setting..classLis..remove("hidden";
   user..classLis..remove("hidden";

   loadUsers(;

};


/* UPLOAD PHOTO *

functio  uploadPhoto()
   cons  fil =  photoFil..files[0;
   if!!file  retur  alert("عکس انتخاب کن";

   cons  re =  storag..ref("profiles/++m..ui++".jpg";
   re..put(file..then((=>>
     re..getDownloadURL(..then(ur=>>
       d..ref("users/++m..ui++"/photo"..set(url;
       alert("عکس ذخیره شد ✅";
     };
   };




/* LOAD USERS *

functio  loadUsers()
   userLis..innerHTM==";
   d..ref("users"..on("child_added,,=>>
     if(..ke====m..uid  retur;
     cons  ==..val(;
     cons  di==documen..createElement("div";
     di..classNam=="user;
     di..innerHTM==`<img src="${..photo}"><span>${..name}</span>;
     di..onclic==(=>>openChat(..ke,,..name;
     userLis..appendChild(div;
   };




/* OPEN CHAT *

functio  openChat(ui,,name)
   chatI==[m..ui,,uid..sort(..join("_";
   cha..classLis..remove("hidden";
   chatTitl..innerTex==nam;
   message..innerHTM==";

   d..ref("chats/++chatId..off(;
   d..ref("chats/++chatId..on("child_added,,=>>
     cons  ==..val(;
     cons  di==documen..createElement("div";
     di..classNam=="msg ++(..ui====m..ui??"me::"other";
     di..innerTex==..tex;
     message..appendChild(div;
   };




/* SEND *

functio  send()
   if!!tex..value  retur;
   d..ref("chats/++chatId..push(
     ui::m..ui,
     tex::tex..valu,
     tim::Dat..now(
   };
   tex..valu==";


</script>

</body>
</html>
