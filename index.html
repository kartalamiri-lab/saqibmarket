<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<title>SAQIB CHAT</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:tahoma;background:#0b0b0f;color:#fff}
.hidden{display:none}
header{background:#111;padding:14px;text-align:center;font-weight:bold}
input,button{width:100%;padding:12px;margin:6px 0;border:none;border-radius:12px}
input{background:#1c1c24;color:#fff}
button{background:#4da3ff;color:#fff;font-weight:bold}
.container{padding:14px}
.user{display:flex;align-items:center;padding:10px;border-bottom:1px solid #222;cursor:pointer}
.user img{width:48px;height:48px;border-radius:50%;margin-left:10px}
#messages{height:60vh;overflow-y:auto}
.msg{max-width:70%;padding:10px;border-radius:18px;margin:6px}
.me{background:#4da3ff;margin-left:auto}
.other{background:#2a2a33}
#sendBox{display:flex;gap:6px}
#sendBox input{flex:1}
nav{position:fixed;bottom:0;left:0;right:0;display:flex;background:#111}
nav button{flex:1;background:#111}
img.avatar{width:80px;height:80px;border-radius:50%;margin:auto;display:block}
ideo{
  width:100%;
  max-height:220px;
  border-radius:12px;
  margin:6px 0;
  background:#000;
}
</style>
 

<</stye
</head>

<body>

<header>SAQIB CHAT</header>

<!-- LOGIN -->
<div id="login" class="container">
  <input id="email" placeholder="Ø§ÛŒÙ…ÛŒÙ„">
  <input id="pass" type="password" placeholder="Ù¾Ø³ÙˆØ±Ø¯">
  <button onclick="loginEmail()">ÙˆØ±ÙˆØ¯ Ø§ÛŒÙ…ÛŒÙ„</button>
  <hr>
  <input id="phone" placeholder="+90xxxxxxxxx">
  <div id="recaptcha"></div>
  <button onclick="loginPhone()">ÙˆØ±ÙˆØ¯ Ø¨Ø§ Ø´Ù…Ø§Ø±Ù‡</button>
</div>

<!-- USERS -->
<div id="users" class="container hidden">
  <h3>Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</h3>
<div style="display:flex;gap:6px;margin-bottom:6px">
  <button onclick="startCall(true)">ğŸ“¹ ØªÙ…Ø§Ø³ ØªØµÙˆÛŒØ±ÛŒ</button>
  <button onclick="startCall(false)">ğŸ“ ØªÙ…Ø§Ø³ ØµÙˆØªÛŒ</button>
</div>

<video id="localVideo" autoplay muted playsinline class="hidden"></video>
<video id="remoteVideo" autoplay playsinline class="hidden"></video>
  
  <div id="userList"></div>
</div>

<!-- CHAT -->
<div id="chat" class="container hidden">
  <h3 id="chatTitle"></h3>
  <button onclick="startCall(true)">ğŸ“¹ ØªÙ…Ø§Ø³ ØªØµÙˆÛŒØ±ÛŒ</button>
<button onclick="startCall(false)">ğŸ“ ØªÙ…Ø§Ø³ ØµÙˆØªÛŒ</button>
<video id="localVideo" autoplay muted playsinline class="hidden"></video>
<video id="remoteVideo" autoplay playsinline class="hidden"></video>
  <div id=d="message></ssa>
  <input type="file" id="imgMsg" accept="image/*">
  <div id="sendBox">
    <input id="msg" placeholder="Ù¾ÛŒØ§Ù…...">
    <button onclick="sendText()">Ø§Ø±Ø³Ø§Ù„</button>
  </div>
</div>

<!-- SETTINGS -->
<div id="settings" class="container hidden">
  <img id="myPhoto" class="avatar">
  <input id="myName" placeholder="Ù†Ø§Ù…">
  <input type="file" id="photoFile" accept="image/*">
  <button onclick="saveProfile()">Ø°Ø®ÛŒØ±Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„</button>
  <button onclick="show('users')">Ø¨Ø±Ú¯Ø´Øª</button>
  <button onclick="logout()" style="background:#ff4d4d">Ø®Ø±ÙˆØ¬</button>
</div>

<nav id="nav" class="hidden">
  <button onclick="show('users')">Ú†Øªâ€ŒÙ‡Ø§</button>
  <button onclick="show('settings')">ØªÙ†Ø¸ÛŒÙ…Ø§Øª</button>
</nav>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyAHJ_2UP6n4RyGcuWmfa1hJA_n8B1C5C2Q",
  authDomain: "saqibmarket.firebaseapp.com",
  databaseURL: "https://saqibmarket-default-rtdb.firebaseio.com",
  projectId: "saqibmarket"
});

const auth=firebase.auth(),db=firebase.database();
const IMGBB="b1dc9d785d3ed51f4f8373e3dacef685";
let me,peer,chatId;

// EMAIL LOGIN
function loginEmail(){
  auth.signInWithEmailAndPassword(email.value,pass.value)
  .catch(()=>auth.createUserWithEmailAndPassword(email.value,pass.value));
}

// PHONE LOGIN
window.onload=()=>recaptcha=new firebase.auth.RecaptchaVerifier('recaptcha',{size:'invisible'});
function loginPhone(){
  auth.signInWithPhoneNumber(phone.value,recaptcha)
  .then(r=>{let c=prompt("Ú©Ø¯");return r.confirm(c)});
}

// AUTH
auth.onAuthStateChanged(u=>{
  if(!u)return;
  me=u;
  login.classList.add("hidden");
  users.classList.remove("hidden");
  nav.classList.remove("hidden");
  db.ref("users/"+u.uid).once("value",s=>{
    if(!s.exists()) db.ref("users/"+u.uid).set({name:"Ú©Ø§Ø±Ø¨Ø±",photo:"https://i.imgur.com/6VBx3io.png"});
  });
  loadUsers();loadMe();
});

// USERS
function loadUsers(){
  userList.innerHTML="";
  db.ref("users").on("child_added",s=>{
    if(s.key===me.uid)return;
    let d=s.val();
    let div=document.createElement("div");
    div.className="user";
    div.innerHTML=`<img src="${d.photo}"><span>${d.name}</span>`;
    div.onclick=()=>openChat(s.key,d.name);
    userList.appendChild(div);
  });
}

 });
}

// CHAT
function openChat(uid,name){
  peer=uid;
  chatId=[me.uid,peer].sort().join("_");
  show("chat");
  chatTitle.innerText=name;
  messages.innerHTML="";
  db.ref("chats/"+chatId).off();
  db.ref("chats/"+chatId).on("child_added",s=>{
    let m=s.val(),d=document.createElement("div");
    d.className="msg "+(m.uid==me.uid?"me":"other");
    d.innerHTML=m.text.startsWith("http")?`<img src="${m.text}" width="200">`:m.text;
    messages.appendChild(d);
  });
}

// SEND TEXT
function sendText(){
  if(!msg.value)return;
  db.ref("chats/"+chatId).push({uid:me.uid,text:msg.value});
  msg.value="";
}

// SENimgMsg.onchange=()=>{
  let f=imgMsg.files[0],fd=new FormData();
  fd.append("image",f);
  fetch("https://api.imgbb.com/1/upload?key="+IMGBB,{method:"POST",body:fd})
  .then(r=>r.json()).then(d=>{
    db.ref("chats/"+chatId).push({uid:me.uid,text:d.data.url});
  });
}

// PROFILE
function loadMe(){
  db.ref("users/"+me.uid).once("value",s=>{
    myName.value=s.val().name;
    myPhoto.src=s.val().photo;
  });
}
function saveProfile(){
  let f=photoFile.files[0],fd=new FormData();
  fd.append("image",f);
  fetch("https://api.imgbb.com/1/upload?key="+IMGBB,{method:"POST",body:fd})
  .then(r=>r.json()).then(d=>{
    db.ref("users/"+me.uid).update({name:myName.value,photo:d.data.url});
    myPhoto.src=d.data.url;
  });
}

// UI
function show(id){
  users.classList.add("hidden");
  chat.classList.add("hidden");
  settings.classList.add("hidden");
  document.getElementById(id).classList.remove("hidden");
}

// LOGOUT
function logout(){auth.signOut();location.reload();}
let pc, localStream;
const servers = {iceServers:[{urls:"stun:stun.l.google.com:19302"}]};

async function startCall(video){
  pc = new RTCPeerConnection(servers);

  localStream = await navigator.mediaDevices.getUserMedia({
    video: video,
    audio: true
  });

  localVideo.srcObject = localStream;
  localVideo.classList.remove("hidden");

  localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));

  pc.ontrack = e=>{
    remoteVideo.srcObject = e.streams[0];
    remoteVideo.classList.remove("hidden");
  };

  const callRef = db.ref("calls/"+chatId);
  const offerCandidates = callRef.child("offerCandidates");
  const answerCandidates = callRef.child("answerCandidates");

  pc.onicecandidate = e=>{
    if(e.candidate) offerCandidates.push(e.candidate.toJSON());
  };

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  await callRef.set({offer});

  callRef.child("answer").on("value",async s=>{
    if(s.exists() && !pc.currentRemoteDescription){
      await pc.setRemoteDescription(new RTCSessionDescription(s.val()));
    }
  });

  answerCandidates.on("child_added",s=>{
    pc.addIceCandidate(new RTCIceCandidate(s.val()));
  });
}

// ANSWER CALL (Ø®ÙˆØ¯Ú©Ø§Ø±)
db.ref("calls").on("child_added",async s=>{
  if(!peer || s.key!==chatId) return;

  pc = new RTCPeerConnection(servers);
  localStream = await navigator.mediaDevices.getUserMedia({audio:true,video:true});
  localVideo.srcObject = localStream;
  localVideo.classList.remove("hidden");

  localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));

  pc.ontrack=e=>{
    remoteVideo.srcObject=e.streams[0];
    remoteVideo.classList.remove("hidden");
  };

  const callRef=db.ref("calls/"+chatId);
  const offerCandidates=callRef.child("offerCandidates");
  const answerCandidates=callRef.child("answerCandidates");

  pc.onicecandidate=e=>{
    if(e.candidate) answerCandidates.push(e.candidate.toJSON());
  };

  const offer=s.val().offer;
  await pc.setRemoteDescription(new RTCSessionDescription(offer));
  const answer=await pc.createAnswer();
  await pc.setLocalDescription(answer);
  await callRef.update({answer});

  offerCandidates.on("child_added",c=>{
    pc.addIceCandidate(new RTCIceCandidate(c.val()));
  });
});
  
</script>

</body>
</html>
